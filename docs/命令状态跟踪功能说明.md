# å‘½ä»¤çŠ¶æ€è·Ÿè¸ªåŠŸèƒ½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ä¸º MCCS ç³»ç»Ÿæ·»åŠ äº†å®Œæ•´çš„å‘½ä»¤æ‰§è¡ŒçŠ¶æ€è·Ÿè¸ªåŠŸèƒ½ï¼Œç”¨æˆ·åœ¨ç‚¹å‡»"åº”ç”¨"æŒ‰é’®å‘å¸ƒæ§åˆ¶å‘½ä»¤åï¼Œå¯ä»¥å®æ—¶æŸ¥çœ‹å‘½ä»¤çš„æ‰§è¡ŒçŠ¶æ€ã€‚

## ğŸ¯ å®ç°çš„åŠŸèƒ½

### 1. å‘½ä»¤æ‰§è¡ŒçŠ¶æ€è·Ÿè¸ª
- âœ… å‘½ä»¤å‘é€æ—¶ï¼šè‡ªåŠ¨åˆ›å»ºå‘½ä»¤è®°å½•ï¼ŒçŠ¶æ€è®¾ä¸º `Executing`
- âœ… å‘½ä»¤æˆåŠŸï¼šçŠ¶æ€ä¿æŒ `Executing`ï¼ˆå¯é€šè¿‡ç¡¬ä»¶åé¦ˆæ›´æ–°ä¸º `Completed`ï¼‰
- âœ… å‘½ä»¤å¤±è´¥ï¼šçŠ¶æ€è®¾ä¸º `Error`ï¼Œå¹¶è®°å½•é”™è¯¯ä¿¡æ¯
- âœ… å®æ—¶çŠ¶æ€æ›´æ–°ï¼šé€šè¿‡äº‹ä»¶æœºåˆ¶å®æ—¶æ›´æ–°UI

### 2. UI å¢å¼º
- âœ… çŠ¶æ€æ æ˜¾ç¤ºï¼šå®æ—¶æ˜¾ç¤ºå½“å‰å‘½ä»¤æ‰§è¡ŒçŠ¶æ€å’Œæ¶ˆæ¯
- âœ… å‘½ä»¤å†å²ï¼šæ˜¾ç¤ºæœ€è¿‘10æ¡å‘½ä»¤æ‰§è¡Œè®°å½•
- âœ… æ‰§è¡Œè€—æ—¶ï¼šè‡ªåŠ¨è®¡ç®—å¹¶æ˜¾ç¤ºå‘½ä»¤æ‰§è¡Œè€—æ—¶
- âœ… å¯æŠ˜å å†å²ï¼šå‘½ä»¤å†å²è®°å½•æ”¯æŒæŠ˜å /å±•å¼€

### 3. é€šçŸ¥æç¤º
- âœ… æˆåŠŸé€šçŸ¥ï¼šå‘½ä»¤æ‰§è¡Œå®Œæˆæ—¶æ˜¾ç¤ºæˆåŠŸæç¤º
- âœ… é”™è¯¯é€šçŸ¥ï¼šå‘½ä»¤æ‰§è¡Œå¤±è´¥æ—¶æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

#### 1. **CommandRecord** - å‘½ä»¤è®°å½•æ¨¡å‹
ä½ç½®: `/src/MCCS.Infrastructure/TestModels/CommandTracking/CommandRecord.cs`

è®°å½•å‘½ä»¤çš„å®Œæ•´ä¿¡æ¯ï¼š
- å‘½ä»¤IDï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
- æ§åˆ¶å™¨IDå’Œè®¾å¤‡ID
- å‘½ä»¤ç±»å‹å’Œå‚æ•°
- æ‰§è¡ŒçŠ¶æ€å’Œæ—¶é—´æˆ³
- é”™è¯¯ä¿¡æ¯
- æ‰§è¡Œè€—æ—¶

#### 2. **ICommandTrackingService** - å‘½ä»¤è·Ÿè¸ªæœåŠ¡æ¥å£
ä½ç½®: `/src/MCCS.Collecter/Services/ICommandTrackingService.cs`

æä¾›å‘½ä»¤è·Ÿè¸ªçš„æ ¸å¿ƒæ–¹æ³•ï¼š
```csharp
CommandRecord CreateCommand(int controllerId, int deviceId, ControlMode commandType, object commandParams);
void UpdateCommandStatus(Guid commandId, CommandExecuteStatusEnum status, string? errorMessage = null);
CommandRecord? GetCommand(Guid commandId);
CommandRecord? GetCurrentExecutingCommand(int controllerId, int deviceId);
ReadOnlyCollection<CommandRecord> GetCommandHistory(int controllerId, int deviceId, int count = 10);
```

#### 3. **CommandTrackingService** - æœåŠ¡å®ç°
ä½ç½®: `/src/MCCS.Collecter/Services/CommandTrackingService.cs`

- ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„ `ConcurrentDictionary` å­˜å‚¨å‘½ä»¤è®°å½•
- æŒ‰æ§åˆ¶å™¨å’Œè®¾å¤‡åˆ†ç»„ç®¡ç†å‘½ä»¤å†å²
- è‡ªåŠ¨é™åˆ¶å†å²è®°å½•æ•°é‡ï¼ˆæœ€å¤š100æ¡ï¼‰
- é€šè¿‡ Prism äº‹ä»¶èšåˆå™¨å‘å¸ƒçŠ¶æ€å˜æ›´äº‹ä»¶

#### 4. **CommandStatusChangedEvent** - çŠ¶æ€å˜æ›´äº‹ä»¶
ä½ç½®: `/src/MCCS/Events/Controllers/CommandStatusChangedEvent.cs`

ç”¨äºåœ¨å‘½ä»¤çŠ¶æ€å˜æ›´æ—¶é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…ã€‚

### æ•°æ®æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ç‚¹å‡»"åº”ç”¨"æŒ‰é’®                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ViewModel.ExecuteApplyCommand()                        â”‚
â”‚  - è°ƒç”¨ ControllerService.StaticControl/DynamicControl  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ControllerService                                      â”‚
â”‚  1. åˆ›å»ºå‘½ä»¤è®°å½•ï¼ˆCreateCommandï¼‰                       â”‚
â”‚  2. æ›´æ–°çŠ¶æ€ä¸º Executing                                â”‚
â”‚  3. è°ƒç”¨ç¡¬ä»¶è®¾å¤‡å‘é€å‘½ä»¤                                â”‚
â”‚  4. æ ¹æ®ç»“æœæ›´æ–°çŠ¶æ€ï¼ˆExecuting/Errorï¼‰                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CommandTrackingService                                 â”‚
â”‚  - å‘å¸ƒ CommandStatusChangedEvent äº‹ä»¶                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ViewModel.OnCommandStatusChanged()                     â”‚
â”‚  1. æ›´æ–° CurrentCommandStatus                           â”‚
â”‚  2. æ›´æ–° CommandStatusMessage                           â”‚
â”‚  3. æ›´æ–° CommandHistory                                 â”‚
â”‚  4. æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UI è‡ªåŠ¨åˆ·æ–°                                             â”‚
â”‚  - çŠ¶æ€æ æ˜¾ç¤ºæœ€æ–°çŠ¶æ€                                    â”‚
â”‚  - å†å²è®°å½•åˆ—è¡¨æ›´æ–°                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
1. `/src/MCCS.Infrastructure/TestModels/CommandTracking/CommandRecord.cs` - å‘½ä»¤è®°å½•æ¨¡å‹
2. `/src/MCCS.Collecter/Services/ICommandTrackingService.cs` - æœåŠ¡æ¥å£
3. `/src/MCCS.Collecter/Services/CommandTrackingService.cs` - æœåŠ¡å®ç°
4. `/src/MCCS/Events/Controllers/CommandStatusChangedEvent.cs` - çŠ¶æ€å˜æ›´äº‹ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
1. `/src/MCCS.Collecter/Services/IControllerService.cs` - ä¿®æ”¹æ§åˆ¶æ–¹æ³•ç­¾å
2. `/src/MCCS.Collecter/Services/ControllerService.cs` - é›†æˆå‘½ä»¤è·Ÿè¸ª
3. `/src/MCCS/App.xaml.cs` - æ³¨å†ŒæœåŠ¡åˆ°DIå®¹å™¨
4. `/src/MCCS/ViewModels/Pages/Controllers/ControllerMainPageViewModel.cs` - æ·»åŠ çŠ¶æ€è·Ÿè¸ª
5. `/src/MCCS/Views/Pages/Controllers/ControllerMainPage.xaml` - UIå¢å¼º

## ğŸ“Š çŠ¶æ€è¯´æ˜

### CommandExecuteStatusEnum

| çŠ¶æ€ | å«ä¹‰ | UIæ˜¾ç¤º |
|------|------|--------|
| `Idle` | ç©ºé—² | "å°±ç»ª" |
| `Executing` | æ‰§è¡Œä¸­ | "æ‰§è¡Œä¸­..." |
| `ExecuttionCompleted` | æ‰§è¡Œå®Œæˆ | "æ‰§è¡Œå®Œæˆ (è€—æ—¶: XXms)" |
| `Stoping` | åœæ­¢ä¸­ | "åœæ­¢ä¸­..." |
| `Error` | é”™è¯¯ | "é”™è¯¯: [é”™è¯¯ä¿¡æ¯]" |

## ğŸ¨ UI å˜åŒ–

### çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ
åœ¨"åº”ç”¨"å’Œ"æš‚åœ"æŒ‰é’®ä¸‹æ–¹æ–°å¢äº†çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸï¼š
- **æ ‡é¢˜**: "æ‰§è¡ŒçŠ¶æ€"
- **å†…å®¹**: åŠ¨æ€æ˜¾ç¤ºå½“å‰å‘½ä»¤çŠ¶æ€æ¶ˆæ¯

### å‘½ä»¤å†å²è®°å½•
æ–°å¢å¯æŠ˜å çš„å†å²è®°å½•é¢æ¿ï¼š
- **æ ‡é¢˜**: "å‘½ä»¤å†å² (æœ€è¿‘10æ¡)"
- **å†…å®¹**: åˆ—è¡¨æ˜¾ç¤ºæœ€è¿‘çš„å‘½ä»¤è®°å½•ï¼ŒåŒ…æ‹¬ï¼š
  - å‘½ä»¤ç±»å‹å’ŒçŠ¶æ€
  - åˆ›å»ºæ—¶é—´
  - æ‰§è¡Œè€—æ—¶ï¼ˆå¦‚æœå·²å®Œæˆï¼‰

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### 1. å‘é€é™æ€æ§åˆ¶å‘½ä»¤

```csharp
// åœ¨ ViewModel ä¸­
var commandRecord = _controllerService.StaticControl(controllerId, deviceId,
    new StaticControlParams
    {
        StaticLoadControl = StaticLoadControlEnum.CTRLMODE_LoadN,
        Speed = 10.0f,
        TargetValue = 100.0f
    });

if (commandRecord != null)
{
    // å‘½ä»¤åˆ›å»ºæˆåŠŸï¼Œå¯ä»¥é€šè¿‡ commandRecord.CommandId è·Ÿè¸ªçŠ¶æ€
    Console.WriteLine($"å‘½ä»¤ID: {commandRecord.CommandId}");
    Console.WriteLine($"å½“å‰çŠ¶æ€: {commandRecord.Status}");
}
```

### 2. æŸ¥è¯¢å‘½ä»¤å†å²

```csharp
// è·å–æœ€è¿‘10æ¡å‘½ä»¤å†å²
var history = _commandTrackingService.GetCommandHistory(controllerId, deviceId, 10);

foreach (var cmd in history)
{
    Console.WriteLine($"{cmd.CommandType} - {cmd.Status} - {cmd.CreatedTime}");
}
```

### 3. è®¢é˜…çŠ¶æ€å˜æ›´äº‹ä»¶

```csharp
// åœ¨ ViewModel æ„é€ å‡½æ•°ä¸­
_eventAggregator.GetEvent<CommandStatusChangedEvent>()
    .Subscribe(OnCommandStatusChanged);

private void OnCommandStatusChanged(CommandStatusChangedEventParam param)
{
    var commandRecord = param.CommandRecord;

    // æ›´æ–°UI
    CurrentCommandStatus = commandRecord.Status;

    // æ˜¾ç¤ºé€šçŸ¥
    if (commandRecord.Status == CommandExecuteStatusEnum.ExecuttionCompleted)
    {
        _notificationService.Show("æˆåŠŸ", "å‘½ä»¤æ‰§è¡Œå®Œæˆï¼", NotificationType.Success);
    }
}
```

## ğŸ”® æœªæ¥æ‰©å±•

### 1. ç¡¬ä»¶åé¦ˆé›†æˆï¼ˆå¾…å®ç°ï¼‰
å½“å‰å‘½ä»¤å‘é€æˆåŠŸåçŠ¶æ€ä¿æŒä¸º `Executing`ï¼Œå¯ä»¥é€šè¿‡ç›‘å¬ç¡¬ä»¶æ•°æ®æµæ¥åˆ¤æ–­å‘½ä»¤æ˜¯å¦çœŸæ­£æ‰§è¡Œå®Œæˆï¼š

```csharp
private void OnCommandExecuteStatus(BatchCollectItemModel param)
{
    if (_currentCommandRecord != null)
    {
        // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç›®æ ‡å€¼
        if (IsTargetReached(param))
        {
            _commandTrackingService.UpdateCommandStatus(
                _currentCommandRecord.CommandId,
                CommandExecuteStatusEnum.ExecuttionCompleted);
        }
    }
}
```

### 2. å‘½ä»¤å–æ¶ˆåŠŸèƒ½
å®ç°å‘½ä»¤å–æ¶ˆåŠŸèƒ½ï¼š
- æ·»åŠ å–æ¶ˆæŒ‰é’®
- å®ç° `CancelCommand` æ–¹æ³•
- æ›´æ–°çŠ¶æ€ä¸º `Cancelled`

### 3. å‘½ä»¤é‡è¯•æœºåˆ¶
å¯¹äºå¤±è´¥çš„å‘½ä»¤ï¼Œæä¾›é‡è¯•åŠŸèƒ½ï¼š
- ä»å†å²è®°å½•ä¸­é€‰æ‹©å¤±è´¥çš„å‘½ä»¤
- ç‚¹å‡»é‡è¯•æŒ‰é’®é‡æ–°æ‰§è¡Œ

### 4. æŒä¹…åŒ–å­˜å‚¨
å°†å‘½ä»¤å†å²ä¿å­˜åˆ°æ•°æ®åº“ï¼š
- é•¿æœŸä¿å­˜å‘½ä»¤æ‰§è¡Œè®°å½•
- æ”¯æŒæŒ‰æ—¶é—´ã€çŠ¶æ€ç­‰æ¡ä»¶æŸ¥è¯¢
- ç”Ÿæˆç»Ÿè®¡æŠ¥è¡¨

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **çº¿ç¨‹å®‰å…¨**: `CommandTrackingService` ä½¿ç”¨ `ConcurrentDictionary` ç¡®ä¿çº¿ç¨‹å®‰å…¨
2. **UIæ›´æ–°**: çŠ¶æ€å˜æ›´å›è°ƒä¸­ä½¿ç”¨ `Dispatcher.Invoke` ç¡®ä¿åœ¨UIçº¿ç¨‹æ›´æ–°
3. **å†…å­˜ç®¡ç†**: å†å²è®°å½•è‡ªåŠ¨é™åˆ¶ä¸º100æ¡ï¼Œé˜²æ­¢å†…å­˜å ç”¨è¿‡å¤§
4. **æ€§èƒ½**: ä½¿ç”¨äº‹ä»¶æœºåˆ¶é¿å…è½®è¯¢ï¼Œæé«˜æ€§èƒ½

## ğŸ“ æ€»ç»“

æ­¤æ¬¡å®ç°ä¸º MCCS ç³»ç»Ÿæ·»åŠ äº†å®Œæ•´çš„å‘½ä»¤çŠ¶æ€è·Ÿè¸ªåŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥ï¼š
- âœ… å®æ—¶æŸ¥çœ‹å‘½ä»¤æ‰§è¡ŒçŠ¶æ€
- âœ… æŸ¥çœ‹å‘½ä»¤æ‰§è¡Œå†å²
- âœ… è·å–è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- âœ… äº†è§£å‘½ä»¤æ‰§è¡Œè€—æ—¶

è¯¥åŠŸèƒ½åŸºäºäº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œä¸ç°æœ‰ç³»ç»Ÿæ— ç¼é›†æˆï¼Œä¸ºåç»­åŠŸèƒ½æ‰©å±•æä¾›äº†è‰¯å¥½çš„åŸºç¡€ã€‚
