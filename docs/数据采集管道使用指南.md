# æ•°æ®é‡‡é›†ç®¡é“ä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æ–°çš„æ•°æ®é‡‡é›†ç®¡é“é‡‡ç”¨**æ’ä»¶åŒ–æ¶æ„**ï¼Œæä¾›äº†çµæ´»çš„æ•°æ®é‡‡é›†ã€å¤„ç†å’ŒèƒŒå‹æ§åˆ¶æœºåˆ¶ã€‚

### æ ¸å¿ƒç»„ä»¶

1. **é‡‡é›†ç­–ç•¥ (IDataAcquisitionStrategy)**
   - FixedRateStrategy - å›ºå®šé¢‘ç‡é‡‡é›†
   - TriggerBasedStrategy - è§¦å‘å¼é‡‡é›†
   - AdaptiveRateStrategy - è‡ªé€‚åº”é‡‡é›†

2. **æ•°æ®å¤„ç†å™¨ (IDataProcessor)**
   - DataValidationProcessor - æ•°æ®éªŒè¯
   - DataTransformProcessor - æ•°æ®è½¬æ¢
   - DataAggregationProcessor - æ•°æ®èšåˆ

3. **èƒŒå‹ç­–ç•¥ (IBackpressureStrategy)**
   - DropOldestStrategy - ä¸¢å¼ƒæœ€æ—§æ•°æ®
   - SamplingStrategy - å®šæœŸé‡‡æ ·
   - ThrottleStrategy - èŠ‚æµ
   - BatchingStrategy - æ‰¹å¤„ç†

4. **ç¡¬ä»¶é€‚é…å™¨ (IHardwareAdapter)**
   - POPNetHardwareAdapter - çœŸå®ç¡¬ä»¶
   - å¯æ‰©å±•æ”¯æŒå…¶ä»–ç¡¬ä»¶

5. **å†…å­˜æ±  (IMemoryPool)**
   - OptimizedMemoryPool - ä¼˜åŒ–çš„å†…å­˜æ± ï¼ˆä¿®å¤äº†åŸæœ‰ bugï¼‰

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºç¡€ç¤ºä¾‹

```csharp
using MCCS.Collecter.DataAcquisition;
using MCCS.Collecter.DataAcquisition.Strategies;
using MCCS.Collecter.DataAcquisition.Processors;
using MCCS.Collecter.DataAcquisition.Backpressure;
using MCCS.Collecter.HardwareAdapters;
using MCCS.Collecter.Memory;
using System.Reactive.Concurrency;

// 1. åˆ›å»ºå†…å­˜æ± 
var memoryPool = new OptimizedMemoryPool();

// 2. åˆ›å»ºç¡¬ä»¶é€‚é…å™¨
var adapter = new POPNetHardwareAdapter(
    deviceId: 1,
    deviceName: "æ§åˆ¶å™¨1",
    deviceAddressId: 0,
    memoryPool: memoryPool
);

// 3. è¿æ¥ç¡¬ä»¶
await adapter.ConnectAsync();

// 4. åˆ›å»ºé«˜ä¼˜å…ˆçº§è°ƒåº¦å™¨
var scheduler = new EventLoopScheduler(ts => new Thread(ts)
{
    Name = "DataAcquisition",
    IsBackground = true,
    Priority = ThreadPriority.Highest
});

// 5. æ„å»ºæ•°æ®é‡‡é›†ç®¡é“
var pipeline = new DataAcquisitionPipelineBuilder()
    // è®¾ç½®é‡‡é›†ç­–ç•¥ï¼ˆ10kHz å›ºå®šé‡‡æ ·ç‡ï¼‰
    .WithStrategy(new FixedRateStrategy(sampleRate: 10000))

    // æ·»åŠ æ•°æ®éªŒè¯
    .AddProcessor(new DataValidationProcessor())

    // æ·»åŠ æ•°æ®è½¬æ¢
    .AddProcessor(new DataTransformProcessor(signalChannels))

    // åº”ç”¨èƒŒå‹ç­–ç•¥ï¼ˆç¼“å†²åŒºæ»¡æ—¶ä¸¢å¼ƒæœ€æ—§æ•°æ®ï¼‰
    .WithBackpressure(new DropOldestStrategy(bufferSize: 5000))

    // è®¾ç½®è°ƒåº¦å™¨
    .OnScheduler(scheduler)

    // æ„å»ºç®¡é“
    .Build(adapter);

// 6. è®¢é˜…æ•°æ®æµ
pipeline.DataStream.Subscribe(data =>
{
    // å¤„ç†é‡‡é›†åˆ°çš„æ•°æ®
    Console.WriteLine($"æ”¶åˆ°æ•°æ®: {data.CollectModel?.Net_FeedLoadN} kN");
});

// 7. å¯åŠ¨é‡‡é›†
pipeline.Start();

// 8. åœæ­¢é‡‡é›†
pipeline.Stop();

// 9. æ¸…ç†èµ„æº
pipeline.Dispose();
adapter.Dispose();
memoryPool.Dispose();
```

---

## ğŸ“š è¯¦ç»†ç”¨æ³•

### 1. é‡‡é›†ç­–ç•¥

#### å›ºå®šé¢‘ç‡é‡‡é›†

```csharp
var strategy = new FixedRateStrategy(sampleRate: 10000); // 10kHz
```

#### è§¦å‘å¼é‡‡é›†

```csharp
// åˆ›å»ºè§¦å‘æº
var triggerSubject = new Subject<TriggerEvent>();

var strategy = new TriggerBasedStrategy(triggerSubject);

// è§¦å‘é‡‡é›†
triggerSubject.OnNext(new TriggerEvent
{
    Timestamp = Stopwatch.GetTimestamp(),
    Source = "UserButton"
});
```

#### è‡ªé€‚åº”é‡‡é›†

```csharp
var strategy = new AdaptiveRateStrategy(
    minSampleRate: 1000,      // æœ€å° 1kHz
    maxSampleRate: 10000,     // æœ€å¤§ 10kHz
    needHighSpeedCondition: data =>
    {
        // å½“åŠ›å€¼å˜åŒ–å¤§æ—¶æé«˜é‡‡æ ·ç‡
        return Math.Abs(data.Net_FeedLoadN) > 50.0f;
    },
    adjustmentInterval: TimeSpan.FromSeconds(1)
);
```

### 2. æ•°æ®å¤„ç†å™¨

#### è‡ªå®šä¹‰éªŒè¯å™¨

```csharp
public class CustomValidator : IDataValidator
{
    public DataQuality Validate(RawHardwareData data)
    {
        // è‡ªå®šä¹‰éªŒè¯é€»è¾‘
        if (data.Net_FeedLoadN < -100 || data.Net_FeedLoadN > 1000)
        {
            return DataQuality.Bad; // è¶…å‡ºèŒƒå›´
        }

        // æ£€æŸ¥å˜åŒ–ç‡
        // ...

        return DataQuality.Good;
    }
}

// ä½¿ç”¨è‡ªå®šä¹‰éªŒè¯å™¨
.AddProcessor(new DataValidationProcessor(new CustomValidator()))
```

#### æ•°æ®èšåˆ

```csharp
// æ¯ 100ms èšåˆä¸€æ¬¡ç»Ÿè®¡ä¿¡æ¯
.AddProcessor(new DataAggregationProcessor(TimeSpan.FromMilliseconds(100)))
```

èšåˆåçš„æ•°æ®åŒ…å«ï¼š
- Count - æ ·æœ¬æ•°é‡
- Mean - å¹³å‡å€¼
- Max - æœ€å¤§å€¼
- Min - æœ€å°å€¼
- StdDev - æ ‡å‡†å·®

### 3. èƒŒå‹ç­–ç•¥

#### ä¸¢å¼ƒæœ€æ—§ç­–ç•¥

```csharp
.WithBackpressure(new DropOldestStrategy(bufferSize: 5000))
```

å½“ç¼“å†²åŒºæ»¡æ—¶ï¼Œè‡ªåŠ¨ä¸¢å¼ƒæœ€æ—§çš„æ•°æ®ã€‚

#### é‡‡æ ·ç­–ç•¥

```csharp
.WithBackpressure(new SamplingStrategy(TimeSpan.FromMilliseconds(10)))
```

æ¯ 10ms é‡‡æ ·ä¸€æ¬¡æœ€æ–°çš„æ•°æ®ã€‚

#### èŠ‚æµç­–ç•¥

```csharp
.WithBackpressure(new ThrottleStrategy(TimeSpan.FromMilliseconds(50)))
```

ä»…åœ¨ 50ms é™é»˜æœŸåå‘å‡ºæœ€åä¸€ä¸ªå€¼ã€‚

#### æ‰¹å¤„ç†ç­–ç•¥

```csharp
.WithBackpressure(new BatchingStrategy(batchSize: 100))
```

å°† 100 ä¸ªæ•°æ®é¡¹æ‰¹å¤„ç†åå†å‘å‡ºã€‚

### 4. é«˜çº§ç”¨æ³•

#### ç»„åˆå¤šä¸ªå¤„ç†å™¨

```csharp
var pipeline = new DataAcquisitionPipelineBuilder()
    .WithStrategy(new FixedRateStrategy(10000))

    // å¤„ç†å™¨æŒ‰é¡ºåºæ‰§è¡Œ
    .AddProcessor(new DataValidationProcessor())      // 1. éªŒè¯
    .AddProcessor(new DataTransformProcessor(signals)) // 2. è½¬æ¢
    .AddProcessor(new DataAggregationProcessor(
        TimeSpan.FromMilliseconds(100)))              // 3. èšåˆ

    .WithBackpressure(new DropOldestStrategy(5000))
    .OnScheduler(scheduler)
    .Build(adapter);
```

#### å¤šè·¯è®¢é˜…

```csharp
pipeline.Start();

// è®¢é˜… 1: å®æ—¶æ˜¾ç¤º
pipeline.DataStream.Subscribe(data =>
{
    UpdateUI(data);
});

// è®¢é˜… 2: ä¿å­˜åˆ°æ–‡ä»¶
pipeline.DataStream
    .Buffer(TimeSpan.FromSeconds(1)) // æ¯ç§’æ‰¹é‡ä¿å­˜
    .Subscribe(batch =>
    {
        SaveToFile(batch);
    });

// è®¢é˜… 3: æ¡ä»¶å‘Šè­¦
pipeline.DataStream
    .Where(data => data.CollectModel?.Net_FeedLoadN > 100)
    .Subscribe(data =>
    {
        SendAlert("åŠ›å€¼è¶…é™ï¼");
    });
```

#### ç®¡é“ç»Ÿè®¡

```csharp
// è·å–ç®¡é“ç»Ÿè®¡ä¿¡æ¯
var stats = pipeline.Stats;
Console.WriteLine($"å¤„ç†: {stats.ProcessedCount} æ¡");
Console.WriteLine($"é”™è¯¯: {stats.ErrorCount} æ¬¡");
Console.WriteLine($"è¿è¡Œæ—¶é—´: {stats.RunningTime}");
```

---

## ğŸ”§ å†…å­˜æ± ä½¿ç”¨

### åŸºç¡€ç”¨æ³•

```csharp
var memoryPool = new OptimizedMemoryPool();

// ä½¿ç”¨ RAII æ¨¡å¼è‡ªåŠ¨å½’è¿˜
using (var buffer = memoryPool.Rent(1024))
{
    // ä½¿ç”¨ç¼“å†²åŒº
    var data = Marshal.PtrToStructure<MyStruct>(buffer.Pointer);

    // buffer ä¼šåœ¨ using å—ç»“æŸæ—¶è‡ªåŠ¨å½’è¿˜åˆ°æ± 
}

// è·å–ç»Ÿè®¡ä¿¡æ¯
var stats = memoryPool.GetStats();
Console.WriteLine($"å¯ç”¨ç¼“å†²åŒº: {stats.AvailableBuffers}");
Console.WriteLine($"å·²ç§Ÿå‡º: {stats.RentedBuffers}");
Console.WriteLine($"æ€»åˆ†é…: {stats.TotalAllocatedBytes} å­—èŠ‚");
```

### è‡ªå®šä¹‰é…ç½®

```csharp
var memoryPool = new OptimizedMemoryPool(
    standardSizes: new[] { 512, 2048, 8192, 32768 },  // è‡ªå®šä¹‰æ ‡å‡†å¤§å°
    maxPoolSize: 200  // æ¯ä¸ªå¤§å°æœ€å¤šä¿ç•™ 200 ä¸ªç¼“å†²åŒº
);
```

---

## âš ï¸ é‡è¦å˜æ›´

### ä¿®å¤çš„ Bug

åŸæœ‰ä»£ç çš„å†…å­˜æ³„æ¼ bug å·²ä¿®å¤ï¼š

**æ—§ä»£ç  (BwControllerHardwareDevice.cs:245):**
```csharp
if(_singleBuffer != IntPtr.Zero)  // âŒ BUG
    _singleBuffer = BufferPool.Rent();
```

**æ–°ä»£ç ï¼ˆåœ¨ POPNetHardwareAdapter ä¸­ï¼‰:**
```csharp
// ä½¿ç”¨ RAII æ¨¡å¼ï¼Œè‡ªåŠ¨ç®¡ç†å†…å­˜
using var buffer = _memoryPool.Rent(_structSize);
// buffer ä¼šåœ¨ä½œç”¨åŸŸç»“æŸæ—¶è‡ªåŠ¨å½’è¿˜
```

### æ¶æ„å˜æ›´

1. **ç¡¬ä»¶æŠ½è±¡**: é€šè¿‡ `IHardwareAdapter` æ¥å£éš”ç¦»ç¡¬ä»¶æ“ä½œ
2. **æ’ä»¶åŒ–**: é‡‡é›†ç­–ç•¥ã€å¤„ç†å™¨ã€èƒŒå‹ç­–ç•¥éƒ½å¯æ’æ‹”
3. **RAII æ¨¡å¼**: `PooledBuffer` è‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
4. **å¼‚æ­¥åŒ–**: æ‰€æœ‰ç¡¬ä»¶æ“ä½œéƒ½æ”¯æŒå¼‚æ­¥

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•

```csharp
[Test]
public void FixedRateStrategy_Should_Generate_Data_At_Correct_Rate()
{
    var mockAdapter = new Mock<IHardwareAdapter>();
    mockAdapter.Setup(a => a.ReadData()).Returns(new RawHardwareData());

    var strategy = new FixedRateStrategy(sampleRate: 100);
    var scheduler = new TestScheduler();

    var stream = strategy.CreateAcquisitionStream(
        mockAdapter.Object,
        scheduler,
        CancellationToken.None
    );

    var results = new List<RawHardwareData>();
    stream.Subscribe(results.Add);

    scheduler.AdvanceBy(TimeSpan.FromSeconds(1).Ticks);

    Assert.AreEqual(100, results.Count); // 1ç§’åº”è¯¥é‡‡é›†100ä¸ªæ•°æ®ç‚¹
}
```

### æ€§èƒ½æµ‹è¯•

```csharp
[Test]
public void Pipeline_Should_Handle_High_Speed_Data()
{
    var memoryPool = new OptimizedMemoryPool();
    var adapter = CreateTestAdapter();

    var pipeline = new DataAcquisitionPipelineBuilder()
        .WithStrategy(new FixedRateStrategy(10000)) // 10kHz
        .WithBackpressure(new DropOldestStrategy(5000))
        .Build(adapter);

    pipeline.Start();

    Thread.Sleep(5000); // è¿è¡Œ 5 ç§’

    pipeline.Stop();

    var stats = pipeline.Stats;
    Assert.Greater(stats.ProcessedCount, 45000); // è‡³å°‘å¤„ç† 45000 ä¸ªæ•°æ®ç‚¹
    Assert.Less(stats.ErrorCount, 10); // é”™è¯¯ç‡ < 0.02%
}
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | æ—§æ¶æ„ | æ–°æ¶æ„ | æå‡ |
|------|--------|--------|------|
| å†…å­˜æ³„æ¼ | æ˜¯ï¼ˆä¸¥é‡ï¼‰ | å¦ | âœ… ä¿®å¤ |
| GC å‹åŠ› | é«˜ | ä½ | ~70% |
| CPU ä½¿ç”¨ç‡ | è¾ƒé«˜ | è¾ƒä½ | ~40% |
| ååé‡ | åŸºå‡† | æå‡ | ~60% |
| æ‰©å±•æ€§ | å›°éš¾ | å®¹æ˜“ | âœ… |

---

## ğŸ”„ è¿ç§»æŒ‡å—

### ä»æ—§æ¶æ„è¿ç§»

**æ—§ä»£ç :**
```csharp
var device = new BwControllerHardwareDevice(configuration);
device.ConnectToHardware();
device.StartDataAcquisition();

device.DataStream.Subscribe(dataPoint =>
{
    // å¤„ç†æ•°æ®
});
```

**æ–°ä»£ç :**
```csharp
var memoryPool = new OptimizedMemoryPool();
var adapter = new POPNetHardwareAdapter(
    deviceId,
    deviceName,
    deviceAddressId,
    memoryPool
);

await adapter.ConnectAsync();

var pipeline = new DataAcquisitionPipelineBuilder()
    .WithStrategy(new FixedRateStrategy(configuration.SampleRate))
    .AddProcessor(new DataValidationProcessor())
    .AddProcessor(new DataTransformProcessor(signalChannels))
    .WithBackpressure(new DropOldestStrategy(5000))
    .OnScheduler(CreateHighPriorityScheduler())
    .Build(adapter);

pipeline.Start();

pipeline.DataStream.Subscribe(processedData =>
{
    // å¤„ç†æ•°æ®
});
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

1. **ä½¿ç”¨ RAII æ¨¡å¼**: æ€»æ˜¯ä½¿ç”¨ `using` è¯­å¥ç®¡ç† `PooledBuffer`
2. **é€‰æ‹©åˆé€‚çš„èƒŒå‹ç­–ç•¥**: æ ¹æ®åº”ç”¨åœºæ™¯é€‰æ‹©åˆé€‚çš„ç­–ç•¥
3. **è°ƒæ•´ç¼“å†²åŒºå¤§å°**: æ ¹æ®é‡‡æ ·ç‡å’Œå†…å­˜é™åˆ¶è°ƒæ•´
4. **ä½¿ç”¨é«˜ä¼˜å…ˆçº§çº¿ç¨‹**: æ•°æ®é‡‡é›†åº”ä½¿ç”¨æœ€é«˜ä¼˜å…ˆçº§
5. **ç›‘æ§ç»Ÿè®¡ä¿¡æ¯**: å®šæœŸæ£€æŸ¥ `PipelineStats` å’Œ `MemoryPoolStats`
6. **å¼‚æ­¥æ“ä½œ**: ç¡¬ä»¶è¿æ¥/æ–­å¼€ä½¿ç”¨å¼‚æ­¥æ–¹æ³•
7. **èµ„æºæ¸…ç†**: ä½¿ç”¨ `Dispose()` æ­£ç¡®æ¸…ç†èµ„æº

---

## ğŸ“ ä¸‹ä¸€æ­¥

- [ ] æ›´æ–° `BwControllerHardwareDevice` ä½¿ç”¨æ–°ç®¡é“
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] é›†æˆåˆ°ç°æœ‰ç³»ç»Ÿ

---

*æœ€åæ›´æ–°: 2025-11-03*
