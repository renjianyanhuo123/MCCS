<UserControl x:Class="MCCS.Views.Pages.StationSites.StationSiteModel3DSettingPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:MCCS.Views.Pages.StationSites"
             xmlns:stationSites="clr-namespace:MCCS.ViewModels.Pages.StationSites"
             xmlns:prism="http://prismlibrary.com/"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:b="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:hardwares="clr-namespace:MCCS.Converters.Hardwares" xmlns:hx="http://helix-toolkit.org/wpf/SharpDX"
             xmlns:mah="clr-namespace:MahApps.Metro.Controls;assembly=MahApps.Metro"
             xmlns:modelSetttings="clr-namespace:MCCS.Converters.ModelSetttings"
             prism:ViewModelLocator.AutoWireViewModel="True"
             mc:Ignorable="d" 
             d:DesignHeight="1080" d:DesignWidth="1920" d:DataContext="{d:DesignInstance Type=stationSites:StationSiteModel3DSettingPageViewModel}">
    <UserControl.Resources> 
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"></BooleanToVisibilityConverter>
        <hardwares:ReverseBooleanToVisibilityConverter x:Key="ReverseBooleanToVisibilityConverter" />
        <modelSetttings:ModelFileIsNullToVisilityConverter x:Key="ModelFileIsNullToVisilityConverter" />
        <modelSetttings:BillBoradInfoIsNullToVisilityConverter x:Key="BillBoradInfoIsNullToVisilityConverter"/>
        <modelSetttings:BillboardTypeToVisilityConverter x:Key="BillboardTypeToVisilityConverter" />
    </UserControl.Resources>
    <b:Interaction.Triggers>
        <b:EventTrigger EventName="Loaded">
            <b:InvokeCommandAction 
                Command="{Binding LoadCommand}" />
        </b:EventTrigger>
    </b:Interaction.Triggers>
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"></ColumnDefinition>
            <ColumnDefinition Width="400"></ColumnDefinition>
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="300" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <StackPanel Grid.Column="0" Grid.Row="0" Orientation="Vertical" Background="DarkGray">
            <Border Width="Auto" BorderBrush="Gray" BorderThickness="0,0,0,2">
                <StackPanel Orientation="Horizontal">
                    <Button
                        Width="200"
                        HorizontalAlignment="Left"
                        Margin="20"
                        Content="选择导入模型文件" 
                        Command="{Binding ImportModelFileCommand}"
                        Style="{StaticResource MaterialDesignFlatSecondaryLightBgButton}" />
                    <Button Style="{StaticResource MaterialDesignFlatSecondaryLightBgButton}"
                            Width="150"
                            Content="新增广告牌文本"
                            Command="{Binding AddBillboardTextCommand}"
                            ></Button>
                </StackPanel>
            </Border>
            <Border
                Height="Auto"
                Width="64"
                Visibility="{Binding HaveData, Converter={StaticResource ReverseBooleanToVisibilityConverter}}">
                <Viewbox>
                    <materialDesign:PackIcon Kind="NoteSearch" />
                </Viewbox>
            </Border> 
            <ListBox Height="200"
                     ItemsSource="{Binding Model3DFiles}"
                     SelectedItem="{Binding SelectedModel3DFile}" 
                     ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                     ScrollViewer.VerticalScrollBarVisibility="Auto"
                     ScrollViewer.CanContentScroll="False"
                     VirtualizingPanel.ScrollUnit="Pixel"
                     BorderThickness="0"
                     Background="Transparent">
                <!-- ItemContainerStyle 和 ItemTemplate 保持不变 -->
                <ListBox.ItemContainerStyle>
                    <Style TargetType="ListBoxItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        <Setter Property="Padding" Value="0"/>
                        <Setter Property="Margin" Value="0"/>
                        <Setter Property="BorderThickness" Value="0"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ListBoxItem">
                                    <Border x:Name="BorderContainer"
                                            Margin="0,1"
                                            Padding="16,12"
                                            Background="White"
                                            BorderBrush="#E5E7EB"
                                            BorderThickness="0,0,0,1"
                                            CornerRadius="0">
                                        <ContentPresenter/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="BorderContainer" Property="Background" Value="#F9FAFB"/>
                                        </Trigger>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter TargetName="BorderContainer" Property="Background" Value="#EBF8FF"/>
                                            <Setter TargetName="BorderContainer" Property="BorderBrush" Value="#3B82F6"/>
                                            <Setter TargetName="BorderContainer" Property="BorderThickness" Value="2,0,0,1"/>
                                        </Trigger>
                                        <MultiTrigger>
                                            <MultiTrigger.Conditions>
                                                <Condition Property="IsSelected" Value="True"/>
                                                <Condition Property="IsMouseOver" Value="True"/>
                                            </MultiTrigger.Conditions>
                                            <Setter TargetName="BorderContainer" Property="Background" Value="#DBEAFE"/>
                                        </MultiTrigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ListBox.ItemContainerStyle>
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="1*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <Ellipse Grid.Column="0"
                         Width="8"
                         Height="8"
                         Fill="#6B7280"
                         VerticalAlignment="Center"
                         Margin="0,0,12,0" />

                            <StackPanel Grid.Column="1"
                            Orientation="Vertical"
                            VerticalAlignment="Center">
                                <TextBlock Text="{Binding FileName}"
                               FontSize="14"
                               FontWeight="Medium"
                               Foreground="#111827"
                               TextTrimming="CharacterEllipsis"
                               Margin="0,0,0,2" />
                                <TextBlock Text="{Binding FilePath}"
                               FontSize="12"
                               Foreground="#6B7280"
                               TextTrimming="CharacterEllipsis"
                               Opacity="0.8" />
                            </StackPanel>

                            <Border Grid.Column="2" 
                        Height="32" 
                        Width="32"
                        Cursor="Hand"
                        Background="Transparent"
                        CornerRadius="16">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="#FFEBEE"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <b:Interaction.Triggers>
                                    <b:EventTrigger EventName="MouseDown">
                                        <b:InvokeCommandAction 
                                Command="{Binding DataContext.DeleteFileCommand,RelativeSource={RelativeSource AncestorType=UserControl}}"
                                CommandParameter="{Binding Key}"/>
                                    </b:EventTrigger>
                                </b:Interaction.Triggers>
                                <Viewbox Margin="4">
                                    <materialDesign:PackIcon Kind="DeleteForever" 
                                                 Foreground="#F44336"
                                                 VerticalAlignment="Center"
                                                 HorizontalAlignment="Center" />
                                </Viewbox>
                            </Border>
                        </Grid>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </StackPanel>
        <hx:Viewport3DX
            Grid.Column="0" 
            x:Name="EditModel"
            Grid.Row="1"
            BackgroundColor="{Binding CameraBackground}"
            Camera="{Binding Camera}"
            EffectsManager="{Binding EffectsManager}"
            EnableSwapChainRendering="True"
            FXAALevel="Low" 
            FixedRotationPointEnabled="True">
            <hx:Viewport3DX.InputBindings>
                <KeyBinding Key="B" Command="hx:ViewportCommands.BackView" />
                <KeyBinding Key="F" Command="hx:ViewportCommands.FrontView" />
                <KeyBinding Key="U" Command="hx:ViewportCommands.TopView" />
                <KeyBinding Key="D" Command="hx:ViewportCommands.BottomView" />
                <KeyBinding Key="L" Command="hx:ViewportCommands.LeftView" />
                <KeyBinding Key="R" Command="hx:ViewportCommands.RightView" />
                <KeyBinding Command="hx:ViewportCommands.ZoomExtents" Gesture="Control+E" />
                <!-- 新增 Delete 键绑定 -->
                <KeyBinding Key="Delete" Command="{Binding DeleteBillboardCommand}" />
                <MouseBinding Command="hx:ViewportCommands.Rotate" Gesture="RightClick" />
                <MouseBinding Command="hx:ViewportCommands.Zoom" Gesture="MiddleClick" />
                <MouseBinding Command="hx:ViewportCommands.Pan" Gesture="Control+LeftClick" />
            </hx:Viewport3DX.InputBindings>
            <b:Interaction.Triggers>
                <b:EventTrigger EventName="MouseDown3D">
                    <b:InvokeCommandAction Command="{Binding TextInfoMouseDownCommand}" PassEventArgsToCommand="True" />
                </b:EventTrigger>
            </b:Interaction.Triggers>
            <hx:AmbientLight3D Color="#363636" />
            <hx:DirectionalLight3D Direction="{Binding Camera.LookDirection}" Color="#D6D6D6" />
            <!--<hx:EnvironmentMap3D IsRendering="{Binding RenderEnvironmentMap}" Texture="{Binding EnvironmentMap}" />-->
            <hx:Element3DPresenter Content="{Binding GroupModel}" />
            <hx:PostEffectMeshBorderHighlight EffectName="highlight" />
            <!-- 绑定Billboard文本集合 -->
            <hx:TopMostGroup3D x:Name="TopMostGroup" EnableTopMost="True">
                <!--动态文本: FixedSize: 是否固定大小 Geometry: 绑定到 ViewModel 中的 BatchedText 属性 IsHitTestVisible: 是否可被鼠标事件检测到-->
                <hx:BillboardTextModel3D
                    FixedSize="True"
                    Geometry="{Binding CollectionDataLabels}"  />
            </hx:TopMostGroup3D>
            <!-- 连线 -->
            <hx:LineGeometryModel3D 
                Geometry="{Binding ConnectionLineGeometry}" 
                Color="Blue"
                IsHitTestVisible="False"/>
            <hx:AxisPlaneGridModel3D
                x:Name="AxisPlane" 
                Offset="0" />
        </hx:Viewport3DX>
        <ScrollViewer Grid.Column="1" Grid.Row="0" Grid.RowSpan="2">
            <StackPanel>
                <StackPanel Orientation="Horizontal" Margin="15">
                    <Button 
                        Content="保存模型"
                        Command="{Binding SaveModelCommand}"
                        Style="{StaticResource MaterialDesignPaperSecondaryLightButton}"></Button>
                </StackPanel>
                <Expander Header="相机和背景属性" HorizontalAlignment="Stretch">
                    <StackPanel Orientation="Vertical">
                        <StackPanel Orientation="Vertical" Margin="15">
                            <TextBlock Text="背景颜色" FontSize="14" Margin="0,0,0,15"></TextBlock>
                            <materialDesign:ColorPicker x:Name="ColorPicker" 
                                            Height="200"
                                            Color="{Binding CameraBackground, Delay=25}" />
                        </StackPanel>
                        <StackPanel Orientation="Vertical" Margin="15">
                            <TextBlock Text="相机位置" FontSize="14" Margin="0,0,0,15"></TextBlock>
                            <TextBox Text="{Binding Camera.Position, StringFormat=\{0:0.0\}}" />
                        </StackPanel>
                        <StackPanel Orientation="Vertical" Margin="15">
                            <TextBlock Text="观察方向" FontSize="14" Margin="0,0,0,15"></TextBlock>
                            <TextBox Text="{Binding Camera.LookDirection, StringFormat=\{0:0.0\}}" />
                        </StackPanel>
                        <StackPanel Orientation="Vertical" Margin="15">
                            <TextBlock Text="上方向" FontSize="14" Margin="0,0,0,15"></TextBlock>
                            <TextBox Text="{Binding Camera.UpDirection, StringFormat=\{0:0.0\}}" />
                        </StackPanel>
                        <StackPanel Orientation="Vertical" Margin="15">
                            <TextBlock Text="近裁剪平面" FontSize="14" Margin="0,0,0,15"></TextBlock>
                            <mah:NumericUpDown Value="{Binding Camera.NearPlaneDistance}" Maximum="500"></mah:NumericUpDown>
                        </StackPanel>
                        <StackPanel Orientation="Vertical" Margin="15">
                            <TextBlock Text="远裁剪平面" FontSize="14" Margin="0,0,0,15"></TextBlock>
                            <mah:NumericUpDown Value="{Binding Camera.FarPlaneDistance}" Maximum="1000000000"></mah:NumericUpDown>
                        </StackPanel>
                        <StackPanel Orientation="Vertical" Margin="15">
                            <TextBlock Text="视野宽度" FontSize="14" Margin="0,0,0,15"></TextBlock>
                            <mah:NumericUpDown Value="{Binding Camera.Width}"></mah:NumericUpDown>
                        </StackPanel>
                    </StackPanel>
                </Expander>
                <Expander Header="模型属性" HorizontalAlignment="Stretch">
                    <StackPanel Orientation="Vertical">
                        <StackPanel Orientation="Vertical" Margin="15">
                            <TextBlock Text="模型名称" FontSize="14" Margin="0,0,0,15"></TextBlock>
                            <TextBox Text="{Binding ModelName, UpdateSourceTrigger=PropertyChanged}" />
                        </StackPanel>
                        <StackPanel Orientation="Vertical" Margin="15">
                            <TextBlock Text="模型描述" FontSize="14" Margin="0,0,0,15"></TextBlock>
                            <TextBox Text="{Binding Desprition, UpdateSourceTrigger=PropertyChanged}" />
                        </StackPanel>
                        <StackPanel Orientation="Vertical" Margin="15">
                            <TextBlock Text="模型材质" FontSize="14" Margin="0,0,0,15"></TextBlock>
                            <materialDesign:ColorPicker Height="200"
                                            Color="{Binding MaterialColor, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay, Delay=25}" />
                        </StackPanel>
                    </StackPanel>
                </Expander>
                <Expander 
                    Header="模型绑定"
                    Visibility="{Binding SelectedModel3DFile, Converter={StaticResource ModelFileIsNullToVisilityConverter}}"
                    HorizontalAlignment="Stretch">
                    <StackPanel Orientation="Vertical">
                        <StackPanel Orientation="Vertical" Margin="15">
                            <TextBlock Text="绑定控制通道" FontSize="14" Margin="0,0,0,15"></TextBlock>
                            <ItemsControl
                                    Margin="12,0,12,0"
                                    Grid.IsSharedSizeScope="True"
                                    ItemsSource="{Binding BindingControlChannels}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border
                                            x:Name="Border"
                                            Padding="8">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition SharedSizeGroup="Checkerz" />
                                                    <ColumnDefinition />
                                                </Grid.ColumnDefinitions>
                                                <CheckBox
                                                    VerticalAlignment="Center"
                                                    Command="{Binding DataContext.CheckBoxSelectionChangedCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    IsChecked="{Binding IsSelected}" />
                                                <StackPanel
                                                    Grid.Column="1"
                                                    Margin="8,0,0,0">
                                                    <TextBlock
                                                        FontWeight="Bold"
                                                        FontSize="14"
                                                        Text="{Binding ControlChannelName}" />
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                        <DataTemplate.Triggers>
                                            <DataTrigger
                                                    Binding="{Binding IsSelected}"
                                                    Value="True">
                                                <Setter
                                                    TargetName="Border"
                                                    Property="Background"
                                                    Value="{DynamicResource MaterialDesignSelection}" />
                                            </DataTrigger>
                                        </DataTemplate.Triggers>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel  />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                            </ItemsControl>
                        </StackPanel>
                    </StackPanel>
                </Expander>
                <Expander Header="广告牌信息" HorizontalAlignment="Stretch" Visibility="{Binding SelectedBillBoradInfo, Converter={StaticResource BillBoradInfoIsNullToVisilityConverter}}">
                    <StackPanel Orientation="Vertical">
                        <StackPanel Orientation="Vertical" Margin="15">
                            <TextBlock Text="广告牌名称" FontSize="14" Margin="0,0,0,15"></TextBlock>
                            <TextBox Text="{Binding TextContent, UpdateSourceTrigger=PropertyChanged}" />
                        </StackPanel>
                        <StackPanel Orientation="Vertical" Margin="15">
                            <TextBlock Text="广告牌类型" FontSize="14" Margin="0,0,0,15"></TextBlock> 
                            <ComboBox SelectedIndex="{Binding SelectedBillBoradInfo.BillboardType, UpdateSourceTrigger=PropertyChanged}">
                                <ComboBoxItem TabIndex="0">阀门状态</ComboBoxItem>
                                <ComboBoxItem TabIndex="1">数据采集</ComboBoxItem>
                            </ComboBox>
                        </StackPanel>
                        <StackPanel Orientation="Vertical" Margin="15">
                            <TextBlock Text="绑定模型" FontSize="14" Margin="0,0,0,15"></TextBlock>
                            <ComboBox ItemsSource="{Binding Model3DFiles}"
                                      SelectedItem="{Binding SelectedBillBoradInfo.SelectedModel}"
                                      DisplayMemberPath="FileName"/>
                        </StackPanel>
                        <StackPanel Orientation="Vertical" Margin="15" Visibility="{Binding SelectedBillBoradInfo.BillboardType, Converter={StaticResource BillboardTypeToVisilityConverter}}">
                            <TextBlock Text="绑定控制通道" FontSize="14" Margin="0,0,0,15"></TextBlock>
                            <ComboBox ItemsSource="{Binding SelectedBillBoradInfo.SelectedModel.BindedControlChannelIds}"
                                      SelectedItem="{Binding SelectedBillBoradInfo.SelectedBindedChannel}"
                                      DisplayMemberPath="ControlChannelName"/>
                        </StackPanel>
                        <StackPanel Orientation="Vertical" Margin="15">
                            <TextBlock Text="广告牌背景颜色" FontSize="14" Margin="0,0,0,15"></TextBlock>
                            <materialDesign:ColorPicker Height="200"
                                            Color="{Binding SelectedBillBoradInfo.BackgroundColor1, Delay=25}" />
                        </StackPanel>
                        <StackPanel Orientation="Vertical" Margin="15">
                            <TextBlock Text="广告牌字体颜色" FontSize="14" Margin="0,0,0,15"></TextBlock>
                            <materialDesign:ColorPicker Height="200"
                                            Color="{Binding SelectedBillBoradInfo.FontColor1, Delay=25}" />
                        </StackPanel>
                        <StackPanel Orientation="Vertical" Margin="15">
                            <TextBlock Text="广告牌大小" FontSize="14" Margin="0,0,0,15" />
                            <mah:NumericUpDown Value="{Binding BillboardSize}"></mah:NumericUpDown>
                        </StackPanel>
                        <StackPanel Orientation="Vertical" Margin="15">
                            <TextBlock Text="广告牌位置(X方向)" FontSize="14" Margin="0,0,0,15"></TextBlock>
                            <mah:NumericUpDown Value="{Binding XDistance, Mode=TwoWay}"></mah:NumericUpDown>
                        </StackPanel>
                        <StackPanel Orientation="Vertical" Margin="15">
                            <TextBlock Text="广告牌位置(Y方向)" FontSize="14" Margin="0,0,0,15"></TextBlock>
                            <mah:NumericUpDown Value="{Binding YDistance, Mode=TwoWay}"></mah:NumericUpDown>
                        </StackPanel>
                        <StackPanel Orientation="Vertical" Margin="15">
                            <TextBlock Text="广告牌位置(Z方向)" FontSize="14" Margin="0,0,0,15"></TextBlock>
                            <mah:NumericUpDown Value="{Binding ZDistance, Mode=TwoWay}"></mah:NumericUpDown>
                        </StackPanel>
                    </StackPanel>
                </Expander>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
