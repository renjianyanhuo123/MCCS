<UserControl x:Class="MCCS.WorkflowSetting.Components.WorkflowStepNode"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" 
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:b="http://schemas.microsoft.com/xaml/behaviors" xmlns:viewmodels="clr-namespace:MCCS.WorkflowSetting.Models.Nodes" d:DataContext="{d:DesignInstance Type=viewmodels:StepNode}"
             mc:Ignorable="d" 
             x:Name="WorkflowStepNodeRoot"
             d:DesignHeight="110" d:DesignWidth="260">
    <UserControl.Resources>
        <!-- 圆形图标样式 -->
        <Style x:Key="CircleIconStyle" TargetType="Ellipse">
            <Setter Property="Fill" Value="White"/>
            <Setter Property="Width" Value="48"/>
            <Setter Property="Height" Value="48"/>
        </Style>

        <!-- 链接文本样式 -->
        <Style x:Key="LinkTextStyle" TargetType="TextBlock">
            <Setter Property="Foreground" Value="#1677FF"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Cursor" Value="Hand"/> 
        </Style>
        <Style x:Key="MenuButtonStyle" TargetType="Button">
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" 
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <ContentPresenter HorizontalAlignment="Left" 
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#F5F5F5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
    </UserControl.Resources> 
    <Border Background="White" 
            CornerRadius="8" 
            BorderBrush="#E0E0E0" 
            BorderThickness="1"
            Width="{Binding Width}" 
            Height="{Binding Height}">
        <Border.Effect>
            <DropShadowEffect Color="Gray" 
                            Opacity="0.2" 
                            BlurRadius="10" 
                            ShadowDepth="2"/>
        </Border.Effect> 
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="0.55*"/>
                <RowDefinition Height="0.45*"/>
            </Grid.RowDefinitions>
            <Border Background="#295143" Width="Auto"
                    Visibility="{Binding IsShowShade, Converter={StaticResource BooleanToVisibilityConverter}}"
                    Panel.ZIndex="1"
                    CornerRadius="8"
                    Opacity="0.8"
                    Height="Auto" Grid.RowSpan="2">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center"
                            Margin="0,15, 0,0">
                    <TextBlock Text="确定删除此节点?" 
                               HorizontalAlignment="Center"
                               Margin="0,0,0,10"
                               Foreground="White"
                               FontSize="15"/>
                    <UniformGrid Columns="2" Height="32">
                        <Button Content="取消" 
                                Background="#757575"
                                Command="{Binding CancelCommand}"
                                Width="106" Foreground="White"
                                Margin="0,0,5,0"/>
                        <Button Content="确定删除" Width="106" 
                                Background="#ff3b3b"
                                Command="{Binding ConfigueDeleteCommand}"
                                Margin="5,0,0,0"
                                Foreground="White"></Button>
                    </UniformGrid>
                </StackPanel>
            </Border>
            <Popup x:Name="ContextPopup"
                               StaysOpen="False"
                               AllowsTransparency="True" 
                               Placement="Bottom"
                               IsOpen="{Binding IsOpen}"
                               PlacementTarget="{Binding ElementName=OperationNode}"
                               HorizontalOffset="-180"
                               VerticalOffset="5">
                <Border Padding="0" 
                        CornerRadius="8" 
                        Background="White"
                        MinWidth="200">
                    <Border.Effect>
                        <DropShadowEffect Color="#999999" 
                              Opacity="0.2" 
                              BlurRadius="16" 
                              ShadowDepth="0"/>
                    </Border.Effect>

                    <StackPanel>
                        <!-- 修改名称 -->
                        <Button Style="{StaticResource MenuButtonStyle}"
                                Height="44"
                                Background="Transparent"
                                BorderThickness="0">
                            <StackPanel Orientation="Horizontal" Margin="16,0">
                                <Path Data="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"
                                      Fill="#666666"
                                      Width="16" Height="16"
                                      Stretch="Uniform"
                                      VerticalAlignment="Center"/>
                                <TextBlock Text="修改名称" 
                               FontSize="14"
                               Foreground="#333333"
                               Margin="12,0,0,0"
                               VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button> 

                        <!-- 分隔线 -->
                        <Separator Height="1"  Background="#F0F0F0"  Margin="0"/>

                        <!-- 删除 -->
                        <Button 
                            Style="{StaticResource MenuButtonStyle}"
                            Height="44"
                            Background="Transparent"
                            Command="{Binding DeleteNodeCommand}"
                            BorderThickness="0">
                            <StackPanel Orientation="Horizontal" Margin="16,0">
                                <Path Data="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"
                                      Fill="#FF4444"
                                      Width="16" Height="16"
                                      Stretch="Uniform"
                                      VerticalAlignment="Center"/>
                                <TextBlock Text="删除" 
                               FontSize="14"
                               Foreground="#FF4444"
                               Margin="12,0,0,0"
                               VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Border>
            </Popup>
            <!-- 橙色标题栏 -->
            <Border Grid.Row="0" 
                    Background="{Binding TitleBackground}" 
                    CornerRadius="8,8,0,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"></RowDefinition>
                        <RowDefinition Height="Auto"></RowDefinition>
                    </Grid.RowDefinitions>

                    <!-- 右上角三个点 -->
                    <StackPanel Grid.Row="0"
                                Orientation="Horizontal" 
                                HorizontalAlignment="Right"  
                                Cursor="Hand" 
                                x:Name="OperationNode" 
                                Background="Transparent"
                                Margin="0,15,15,0">
                        <b:Interaction.Triggers>
                            <b:EventTrigger EventName="MouseLeftButtonUp">
                                <b:InvokeCommandAction Command="{Binding OperationNodeClickedCommand}" />
                            </b:EventTrigger>
                        </b:Interaction.Triggers>
                        <Ellipse Width="4" Height="4" Fill="White" Margin="2"/>
                        <Ellipse Width="4" Height="4" Fill="White" Margin="2"/>
                        <Ellipse Width="4" Height="4" Fill="White" Margin="2"/>
                    </StackPanel>

                    <!-- 标题文本 -->
                    <TextBlock Grid.Row="1" Text="{Binding Title}" 
                               Foreground="White" 
                               FontSize="14" 
                               FontWeight="Bold"
                               HorizontalAlignment="Center" 
                               VerticalAlignment="Bottom"
                               Margin="0,0,0,10"/>
                </Grid>
            </Border>

            <!-- 圆形图标 (悬浮在标题栏边缘) -->
            <Ellipse Style="{StaticResource CircleIconStyle}"
                     Grid.Row="0"
                     VerticalAlignment="Top"
                     Panel.ZIndex="4"
                     HorizontalAlignment="Center"
                     Margin="0,-25,0,0">
                <Ellipse.Effect>
                    <DropShadowEffect Color="Gray" 
                                    Opacity="0.3" 
                                    BlurRadius="8" 
                                    ShadowDepth="2"/>
                </Ellipse.Effect>
            </Ellipse>

            <!-- 图标内容 (文件图标) -->
            <Path Grid.Row="0"
                  Data="M12,2 L12,8 L18,8 L18,20 L6,20 L6,2 Z M12,2 L18,8 L12,8 Z"
                  Fill="{Binding TitleBackground}"
                  Stretch="Uniform"
                  Panel.ZIndex="4"
                  Width="20"
                  Height="24"
                  VerticalAlignment="Top"
                  HorizontalAlignment="Center"
                  Margin="0,-12,0,0"/>

            <!-- 内容区域 -->
            <StackPanel Grid.Row="1" 
                       Margin="20,0,0,0"
                       VerticalAlignment="Center">
                <TextBlock x:Name="LinkText"
                         Text="设置此节点" 
                         Style="{StaticResource LinkTextStyle}"
                         HorizontalAlignment="Left" />
            </StackPanel>
        </Grid>
    </Border>
</UserControl>
